package org.datasource.oracle;

import org.datasource.JDBCDataSourceConnector;
import org.springframework.stereotype.Service;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

@Service
public class OracleViewBuilder {
	// SQL Map
	private String SQL_SALARIES_DETAILS_SELECT =
			"SELECT * FROM \"Salaries\"";

	// DataCache
	private List<SalaryDetailsView> salaryDetailsViewList = new ArrayList<>();

	public List<SalaryDetailsView> getViewList() {
		return this.salaryDetailsViewList;
	}

	// building steps
	public OracleViewBuilder build() {
		try (Connection jdbcConnection = jdbcConnector.getConnection()) {
			Statement selectStmt = jdbcConnection.createStatement();
			ResultSet rs = selectStmt.executeQuery(SQL_SALARIES_DETAILS_SELECT);

			salaryDetailsViewList = new ArrayList<>();
			while (rs.next()) {
				String location = rs.getString("Location");
				Integer meanSalary = rs.getInt("Mean Salary");
				Integer numbOfJobs = rs.getInt("NumberOfJobs");
				this.salaryDetailsViewList.add(new SalaryDetailsView(location, meanSalary, numbOfJobs));
			}
			
		} catch (Exception ex) {
			ex.printStackTrace();
		}

		return this;
	}

	/* JDBC Session Management ---------------------------------------- */
	private JDBCDataSourceConnector jdbcConnector;
	public OracleViewBuilder() {
		
		this.jdbcConnector = new JDBCDataSourceConnector("jdbc:oracle:thin:@localhost:1521:orcl", "MYUSER", "password");
		
	}
}
